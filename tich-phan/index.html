<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thử Thách Tích Phân - Thầy Trần Trọng Trị</title>
    <script>
      window.MathJax = { tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --correct: #238636; --wrong: #da3633; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--accent); width: 100%; padding-bottom: 15px; }
        
        #nameModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .name-box { background: var(--card); padding: 40px; border-radius: 15px; text-align: center; border: 2px solid var(--accent); }
        .name-input { padding: 12px; width: 280px; font-size: 1.1rem; border-radius: 6px; border: 1px solid var(--accent); margin-bottom: 20px; background: #0d1117; color: white; outline: none; }
        
        .game-container { max-width: 1050px; width: 100%; display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        @media (max-width: 850px) { .game-container { grid-template-columns: 1fr; } }
        
        .quiz-card { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid #30363d; min-height: 550px; display: flex; flex-direction: column; }
        .round-indicator { color: var(--gold); font-weight: bold; text-transform: uppercase; margin-bottom: 10px; display: block; font-size: 1.2rem; }
        .question-text { font-size: 1.15rem; margin-bottom: 25px; line-height: 1.6; min-height: 80px; }
        
        .options-grid { display: grid; gap: 10px; flex-grow: 1; }
        .btn { background: #21262d; border: 1px solid #30363d; color: var(--text); padding: 12px 20px; border-radius: 8px; cursor: pointer; text-align: left; transition: 0.3s; font-size: 1rem; }
        .btn:hover:not(:disabled) { border-color: var(--accent); background: #30363d; }
        .btn.correct { background: var(--correct) !important; border-color: #fff; }
        .btn.wrong { background: var(--wrong) !important; border-color: #fff; }
        
        .tf-row { display: flex; align-items: center; justify-content: space-between; background: #0d1117; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #30363d; }
        .btn-tf { padding: 8px 15px; border: 1px solid #30363d; border-radius: 6px; cursor: pointer; background: #21262d; color: #fff; font-weight: bold; }
        .btn-tf.active-t { background: var(--correct); }
        .btn-tf.active-f { background: var(--wrong); }
        .btn-tf:disabled { cursor: not-allowed; opacity: 0.8; }

        .short-answer-zone { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .answer-display { background: #000; color: var(--accent); font-size: 2.2rem; padding: 15px; border-radius: 10px; border: 2px solid var(--accent); min-width: 200px; text-align: center; height: 60px; display: flex; align-items: center; justify-content: center; font-family: monospace; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .num-btn { background: #30363d; border: 1px solid var(--accent); color: #fff; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 1.2rem; }
        .num-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .image-box { position: relative; width: 350px; height: 260px; border: 4px solid var(--card); border-radius: 12px; overflow: hidden; margin: 0 auto; background: #000; }
        .grid-overlay { position: absolute; top:0; left:0; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(4, 1fr); }
        .tile { background: #2c3e50; border: 1px solid var(--bg); transition: 0.8s; }
        .tile.open { opacity: 0; transform: scale(0.1); }
        
        .status { margin-top: 20px; background: var(--card); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #30363d; }
        .next-btn { margin-top: 25px; width: 100%; padding: 15px; background: var(--gold); color: #000; border: none; border-radius: 10px; cursor: pointer; display: none; font-weight: bold; font-size: 1.1rem; }
        
        .explanation-box { display: none; background: #1c2128; padding: 15px; margin-top: 20px; border-radius: 8px; border-left: 4px solid var(--accent); text-align: left; font-size: 0.95rem; overflow-y: auto; max-height: 400px; }
        .result-text { font-size: 1.5rem; font-weight: bold; margin: 15px 0; }
    </style>
</head>
<body>

<div id="nameModal">
    <div class="name-box">
        <h2 style="color:var(--gold); margin-top:0;">CHÀO MỪNG CÁC EM</h2>
        <p>Nhập Họ và Tên để bắt đầu bài thi:</p>
        <input type="text" id="studentName" class="name-input" placeholder="Ví dụ: Trần Trọng Trị">
        <br>
        <button class="btn" style="text-align:center; width:100%; background:var(--accent); color:white; font-weight:bold;" onclick="startGame()">BẮT ĐẦU ➜</button>
    </div>
</div>

<header>
    <h1 style="margin:5px 0; color:var(--gold);">GIẢI MÃ TÍCH PHÂN - VER 1.0</h1>
    <p style="margin:5px 0; font-weight:bold;">ThS. Trần Trọng Trị - GV Chuyên Toán Trường THPT Gia Định</p>
</header>

<div class="game-container">
    <div class="quiz-card">
        <span id="round-title" class="round-indicator">Vòng 1</span>
        <div id="q-area">
            <div id="q-text" class="question-text"></div>
            <div id="ans-zone" class="options-grid"></div>
        </div>
        <button id="next-btn" class="next-btn" onclick="handleNext()">XÁC NHẬN</button>
        <div id="explanation" class="explanation-box"></div>
    </div>

    <div class="sidebar">
        <div class="image-box">
            <img src="hinh_game.jpg" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='https://via.placeholder.com/350x260?text=Euler+Calc'">
            <div id="grid" class="grid-overlay"></div>
        </div>
        <div class="status">
            <div style="font-size: 1.6rem; color: var(--gold); font-weight: bold;">ĐIỂM: <span id="score">0.00</span></div>
            <div id="student-display" style="color:var(--accent); font-weight:bold; margin: 10px 0;">Học sinh: ...</div>
            <div style="color: #8b949e; border-top: 1px solid #30363d; padding-top: 10px;">Tiến trình: <span id="q-num">1</span> / 22</div>
        </div>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyu-MpFNTly4cIhVq0cv2YclWmyLtxjQllhss1LzBr2p3vtC02F83Suhh9rUdIoNBzRww/exec";

    let studentName = "";
    let currentIdx = 0, score = 0, userAns = "", v2Ans = [];
    let isShowingExplanation = false;

    const questions = [
        // Vòng 1 (12 câu)
        { type: 'v1', q: "Cho vật thể $(T)$ giới hạn bởi $z=0, z=6$. Thiết diện tại cao độ $z$ là một phần tư hình tròn bán kính $r = \\sqrt{36-z^2}$. Tính giá trị $a$ biết $V = a\\pi$.", a: ["$a=18$", "$a=36$", "$a=72$", "$a=144$"], c: 1, sol: "$S(z) = \\frac{1}{4}\\pi(36-z^2)$. $V = \\int_0^6 S(z)dz = 36\\pi$." },
        { type: 'v1', q: "Một chiếc ly có đường sinh là cung Parabol đỉnh tại tâm đáy nhỏ $O(0;3)$ và qua miệng ly $(12;6)$. Tính hệ số $a$ của $y=ax^2+3$.", a: ["$1/12$", "$1/24$", "$1/48$", "$1/144$"], c: 2, sol: "$6 = a(12^2) + 3 \\Rightarrow 144a = 3 \\Rightarrow a = 1/48$." },
        { type: 'v1', q: "Cho vật thể có thiết diện $S(z) = \\pi e^z$ giới hạn bởi $z=0$ và $z=\\ln 3$. Tính thể tích $V$.", a: ["$\\pi$", "$2\\pi$", "$3\\pi$", "$4\\pi$"], c: 1, sol: "$V = \\pi \\int_0^{\\ln 3} e^z dz = \\pi(e^{\\ln 3} - e^0) = 2\\pi$." },
        { type: 'v1', q: "Tính $V = \\pi \\int_0^1 ze^z dz$. Biết kết quả là $a\\pi$, tìm $a$.", a: ["$a=e$", "$a=1$", "$a=e-1$", "$a=2$"], c: 1, sol: "Từng phần: $\\int ze^z dz = (ze^z - e^z)|_0^1 = 1$." },
        { type: 'v1', q: "Vật thể giới hạn bởi $z=0, z=4$. Thiết diện $S(z) = \\frac{\\pi}{4}(4-z)$. Tính thể tích $V$.", a: ["$\\pi$", "$2\\pi$", "$4\\pi$", "$8\\pi$"], c: 1, sol: "$V = \\frac{\\pi}{4} \\int_0^4 (4-z)dz = 2\\pi$." },
        { type: 'v1', q: "Cho đường biên $x = 2\\sqrt{ze^z}$. Tính diện tích thiết diện $S(z)$ (là 1/4 hình tròn).", a: ["$\\pi ze^z$", "$4\\pi ze^z$", "$\\frac{1}{4}\\pi ze^z$", "$2\\pi ze^z$"], c: 0, sol: "$S(z) = \\frac{1}{4}\\pi (4ze^z) = \\pi ze^z$." },
        { type: 'v1', q: "Viên bi $S_1$ tiếp xúc Parabol $x^2=4y$ tại $y=3$. Tìm tung độ tâm $I_1$.", a: ["$y=3$", "$y=4$", "$y=5$", "$y=6$"], c: 2, sol: "$y_I = y_0 + 2a = 3 + 2(1) = 5$." },
        { type: 'v1', q: "Tính diện tích tam giác $OAB$ với $A(1;0;0), B(0;2;0)$.", a: ["1", "2", "0.5", "4"], c: 0, sol: "$S = 1/2 \\cdot 1 \\cdot 2 = 1$." },
        { type: 'v1', q: "Biên dạng Parabol $y = -\\frac{1}{3}x^2 + 12$. Tìm chiều cao $h$ của trụ nội tiếp bán kính $r$.", a: ["$h = 12 - r^2/3$", "$h = 12 + r^2/3$", "$h = r^2/3$", "$h = 6 - r^2$"], c: 0, sol: "$M(r, h)$ thuộc Parabol nên $h = 12 - r^2/3$." },
        { type: 'v1', q: "Mặt cầu tiếp xúc ly $y=e^x$ tại $x=1$. Pháp tuyến tại tiếp điểm có hệ số góc là:", a: ["$e$", "$-e$", "$1/e$", "$-1/e$"], c: 3, sol: "$y'=e^x \\Rightarrow k=e \\Rightarrow k_n = -1/e$." },
        { type: 'v1', q: "Tính $V = \\frac{\\pi}{64} \\int_0^4 (4-z)^3 dz$.", a: ["$\\pi$", "$2\\pi$", "$\\pi/2$", "$\\pi/4$"], c: 0, sol: "$V = \\frac{\\pi}{64} \\cdot \\frac{4^4}{4} = \\pi$." },
        { type: 'v1', q: "Ly có biên $x = e^y - 1$. Tiếp xúc tại $y=\\ln 2$ thì hoành độ $x_0$ bằng:", a: ["0", "1", "2", "3"], c: 1, sol: "$x_0 = e^{\\ln 2} - 1 = 1$." },
        
        // Vòng 2 (4 câu)
        { type: 'v2', q: "Cho khối nón cao $H=12, R=6$. Trụ nội tiếp cao $y$, bán kính $x$.", items: [
            { l: "Tỉ lệ: $y/12 = (6-x)/6$", r: true },
            { l: "Chiều cao $y = 12 - 2x$", r: true },
            { l: "Thể tích $V = \\pi x^2(12-2x)$", r: true },
            { l: "$V_{max}$ khi $x = 3$", r: false }
        ], sol: "$f'(x) = 12x - 3x^2 = 0 \\Rightarrow x=4$." },
        { type: 'v2', q: "Vật thể giới hạn bởi $z=0, z=4$. Thiết diện 1/4 hình tròn bán kính $r(z) = \\sqrt{1 + 0.75z^2}$.", items: [
            { l: "S(z) = $\\frac{\\pi}{4}(1 + 0.75z^2)$", r: true },
            { l: "Nguyên hàm S(z) là $\\frac{\\pi}{4}(z + 0.25z^3)$", r: true },
            { l: "Thể tích $V = 5\\pi$", r: true },
            { l: "Tại $z=0$, $r=0$", r: false }
        ], sol: "$r(0) = \\sqrt{1+0} = 1$." },
        { type: 'v2', q: "Cho phễu có đường sinh $y = \\frac{1}{72}x^2 + \\frac{1}{12}x + 3$.", items: [
            { l: "Bán kính đáy $r=3$", r: true },
            { l: "Bán kính miệng $r=6$", r: true },
            { l: "Tại $x=6, r=4$", r: true },
            { l: "Dung tích $\\approx 1200$ cm$^3$", r: false }
        ], sol: "$V = 201.2\\pi \\approx 632$ cm$^3$." },
        { type: 'v2', q: "Bi $S_2$ tiếp xúc $S_1$ (tâm $y=5, R=4$). Đỉnh $S_2$ cao $25$.", items: [
            { l: "$I_1I_2 = 4 + R_2$", r: true },
            { l: "$y_{I2} = 9 + R_2$", r: true },
            { l: "$y_{I2} = 25 - R_2$", r: true },
            { l: "$R_2 = 4$", r: false }
        ], sol: "$9+R_2 = 25-R_2 \\Rightarrow R_2 = 8$." },

        // Vòng 3 (6 câu)
        { type: 'v3', q: "Thể tích vật thể $S(z) = \\frac{\\pi}{4}(36-z^2)$ trên $[0;6]$ là $a\\pi$. Tìm $a$.", c: "36", sol: "$V = 36\\pi$." },
        { type: 'v3', q: "Thể tích ly $y = x^2/48 + 3, x \\in [0;12]$. (Làm tròn đơn vị).", c: "633", sol: "$V \\approx 633.35$." },
        { type: 'v3', q: "Tìm $R^2$ của bi tiếp xúc $x = e^y - 1$ tại $y = \\ln 2$.", c: "5", sol: "$1^2 + 2^2 = 5$." },
        { type: 'v3', q: "Biên $y = (e^x+e^{-x})/2, x=\\ln 3$. Tính $k$ biết $R = k\\ln 3$.", c: "1.25", sol: "$R = 1.25\\ln 3$." },
        { type: 'v3', q: "Bán kính $r$ để trụ nội tiếp $y = 12 - x^2/3$ đạt $V_{max}$ (Làm tròn 2 số TP).", c: "4.24", sol: "$r = 3\\sqrt{2} \\approx 4.24$." },
        { type: 'v3', q: "Tìm bán kính $R_2$ trong bài toán 2 viên bi (đỉnh $S_2$ cao 25).", c: "8", sol: "$R_2 = 8$." }
    ];

    function startGame() {
        const input = document.getElementById('studentName').value;
        if(input.trim() === "") { alert("Vui lòng nhập tên!"); return; }
        studentName = input;
        document.getElementById('nameModal').style.display = 'none';
        document.getElementById('student-display').innerText = "Học sinh: " + studentName;
        resetGame();
    }

    function resetGame() {
        currentIdx = 0; score = 0; userAns = "";
        isShowingExplanation = false;
        document.getElementById('score').innerText = "0.00";
        const grid = document.getElementById('grid'); grid.innerHTML = "";
        for(let i=0; i<24; i++) {
            let t = document.createElement('div'); t.className='tile'; t.id='tile-'+i; grid.appendChild(t);
        }
        render();
    }

    function render() {
        isShowingExplanation = false;
        const q = questions[currentIdx];
        document.getElementById('q-num').innerText = currentIdx + 1;
        document.getElementById('q-text').innerHTML = q.q;
        const zone = document.getElementById('ans-zone'), nextBtn = document.getElementById('next-btn');
        zone.innerHTML = ''; nextBtn.style.display = 'none';
        document.getElementById('explanation').style.display = 'none';

        if(q.type === 'v1') {
            document.getElementById('round-title').innerText = "Vòng 1: Trắc nghiệm";
            q.a.forEach((opt, i) => {
                let b = document.createElement('button'); b.className='btn'; b.innerHTML = opt;
                b.onclick = () => checkV1(i, b);
                zone.appendChild(b);
            });
        } else if(q.type === 'v2') {
            document.getElementById('round-title').innerText = "Vòng 2: Đúng/Sai";
            v2Ans = new Array(4).fill(null);
            q.items.forEach((item, i) => {
                let div = document.createElement('div'); div.className='tf-row';
                div.innerHTML = `<div style="flex:1;">${item.l}</div><div style="display:flex; gap:8px;">
                    <button class="btn-tf" id="t-${i}" onclick="setV2(${i},true)">Đúng</button>
                    <button class="btn-tf" id="f-${i}" onclick="setV2(${i},false)">Sai</button>
                </div>`;
                zone.appendChild(div);
            });
            nextBtn.style.display = 'block'; nextBtn.innerText = "XÁC NHẬN";
        } else {
            document.getElementById('round-title').innerText = "Vòng 3: Trả lời ngắn";
            userAns = "";
            zone.innerHTML = `<div class="short-answer-zone"><div class="answer-display" id="disp">- - -</div>
                <div class="numpad">${[1,2,3,4,5,6,7,8,9,0,'.','-'].map(n=>`<button class="num-btn" id="num-${n}" onclick="press('${n}')">${n}</button>`).join('')}
                <button class="num-btn" id="num-C" style="grid-column:span 3; background:var(--wrong); border:none;" onclick="press('C')">XÓA TẤT CẢ</button></div></div>`;
            nextBtn.style.display = 'block'; nextBtn.innerText = "XÁC NHẬN";
        }
        MathJax.typesetPromise();
    }

    function checkV1(idx, btn) {
        if(isShowingExplanation) return;
        const q = questions[currentIdx];
        if(idx === q.c) { btn.classList.add('correct'); score += 0.25; openTile(); }
        else { btn.classList.add('wrong'); }
        document.querySelectorAll('.btn').forEach(b => b.disabled = true);
        showSol();
    }

    function setV2(i, v) { 
        if(isShowingExplanation) return;
        v2Ans[i] = v;
        document.getElementById(`t-${i}`).className = v ? 'btn-tf active-t' : 'btn-tf';
        document.getElementById(`f-${i}`).className = !v ? 'btn-tf active-f' : 'btn-tf';
    }

    function press(v) { 
        if(isShowingExplanation) return;
        if(v === 'C') userAns = ""; else if(userAns.length < 6) userAns += v;
        document.getElementById('disp').innerText = userAns || "- - -";
    }

    function openTile() { 
        const tiles = document.querySelectorAll('.tile:not(.open)');
        if(tiles.length) tiles[Math.floor(Math.random()*tiles.length)].classList.add('open');
    }

    function showSol() {
        isShowingExplanation = true;
        const q = questions[currentIdx];
        
        // Khóa các thành phần tương tác
        if(q.type === 'v2') {
            document.querySelectorAll('.btn-tf').forEach(b => b.disabled = true);
            // Hiện màu đúng sai cho từng ý để đối chiếu
            q.items.forEach((item, i) => {
                const correctBtnId = item.r ? `t-${i}` : `f-${i}`;
                document.getElementById(correctBtnId).style.border = "2px solid #fff";
            });
        }
        if(q.type === 'v3') {
            document.querySelectorAll('.num-btn').forEach(b => b.disabled = true);
        }

        const exp = document.getElementById('explanation');
        exp.innerHTML = "<b>Lời giải:</b> " + q.sol;
        exp.style.display = 'block';
        const nextBtn = document.getElementById('next-btn');
        nextBtn.style.display = 'block';
        nextBtn.innerText = "TIẾP THEO ➜";
        MathJax.typesetPromise();
    }

    function handleNext() {
        const q = questions[currentIdx];
        if(!isShowingExplanation) {
            if(q.type === 'v2') {
                // Kiểm tra xem đã chọn đủ chưa
                if(v2Ans.includes(null)) { alert("Vui lòng chọn Đúng/Sai cho cả 4 ý!"); return; }
                let count = 0; q.items.forEach((item, i) => { if(v2Ans[i] === item.r) count++; });
                const pts = [0, 0.1, 0.25, 0.5, 1.0];
                score += pts[count]; if(count === 4) openTile();
                showSol();
            } else if(q.type === 'v3') {
                if(userAns === "") { alert("Vui lòng nhập đáp án!"); return; }
                if(userAns == q.c) { score += 0.5; openTile(); }
                showSol();
            }
            document.getElementById('score').innerText = score.toFixed(2);
            return;
        }
        currentIdx++;
        if(currentIdx < questions.length) render();
        else finish();
    }

    function finish() {
        let comment = score <= 3.5 ? "Bạn cần cố gắng nhiều." : score <= 5 ? "Bạn cần cố gắng." : score <= 6.5 ? "Bạn ở mức tầm trung." : score < 8 ? "Bạn khá." : score <= 9 ? "Bạn giỏi." : score <= 9.8 ? "Bạn xuất sắc." : "Đỉnh của chóp...";
        document.getElementById('round-title').innerText = "HOÀN THÀNH";
        document.getElementById('q-area').innerHTML = `<div style="text-align:center;"><div class="result-text">${comment}</div><h3>Điểm: ${score.toFixed(2)} / 10.0</h3><button class="btn" style="width:100%; margin-top:10px; text-align:center" onclick="showAllSol()">XEM TẤT CẢ LỜI GIẢI</button><button class="btn" style="width:100%; margin-top:10px; background:#444; text-align:center" onclick="location.reload()">CHƠI LẠI</button></div>`;
        document.querySelectorAll('.tile').forEach(t => t.classList.add('open'));
        fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ name: studentName, score: score.toFixed(2) }) });
    }

    function showAllSol() {
        let h = "<h3>Lời giải chi tiết:</h3>";
        questions.forEach((q, i) => h += `<p><b>Câu ${i+1}:</b> ${q.sol}</p>`);
        document.getElementById('q-area').innerHTML = `<div style="text-align:left; overflow-y:auto; max-height:450px;">${h}<button class="btn" onclick="location.reload()">ĐÓNG</button></div>`;
        MathJax.typesetPromise();
    }
</script>
</body>
</html>
