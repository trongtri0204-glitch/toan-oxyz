<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ki·ªÉm Tra T√≠ch Ph√¢n - ThS. Tr·∫ßn Tr·ªçng Tr·ªã</title>
    <script>
      window.MathJax = {
        tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
        options: { processHtmlClass: 'mathjax-process' }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --correct: #238636; --wrong: #da3633; --gold: #f1c40f; --ai: #8a2be2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; user-select: none; }
        header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid var(--accent); width: 100%; padding-bottom: 10px; }
        #timer-box { position: fixed; top: 15px; right: 15px; background: #000; color: var(--gold); padding: 10px 20px; border-radius: 8px; border: 2px solid var(--gold); font-weight: bold; font-size: 1.2rem; z-index: 1000; font-family: monospace; display: none; }
        .timer-warning { color: var(--wrong) !important; border-color: var(--wrong) !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        #nameModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .name-box { background: var(--card); padding: 40px; border-radius: 15px; text-align: center; border: 2px solid var(--accent); width: 95%; max-width: 800px; }
        .name-box h2 { color: var(--gold); font-size: 1.6rem; margin-bottom: 10px; }
        .name-input { padding: 15px; width: 80%; font-size: 1.1rem; border-radius: 8px; border: 1px solid var(--accent); margin-bottom: 20px; background: #0d1117; color: white; outline: none; }
        .nav-section { width: 100%; max-width: 1050px; background: #161b22; padding: 10px; border-radius: 10px; border: 1px solid #30363d; margin-bottom: 15px; display: none; flex-direction: column; }
        .nav-group { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 8px; }
        .nav-label { font-size: 0.75rem; color: var(--gold); font-weight: bold; width: 100%; text-align: center; margin-bottom: 3px; }
        .nav-btn { width: 32px; height: 32px; border-radius: 5px; border: 1px solid #30363d; background: #21262d; color: white; cursor: pointer; font-size: 0.8rem; transition: 0.3s; }
        .nav-btn.active { background: var(--accent); border-color: white; font-weight: bold; }
        .nav-btn.done { border-bottom: 3px solid var(--correct); }
        .game-container { max-width: 1050px; width: 100%; display: none; grid-template-columns: 1fr 300px; gap: 15px; }
        @media (max-width: 850px) { .game-container { grid-template-columns: 1fr; } }
        .quiz-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #30363d; min-height: 480px; display: flex; flex-direction: column; }
        .part-indicator { color: var(--gold); font-weight: bold; background: #21262d; padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid var(--gold); font-size: 0.9rem; }
        .q-text { font-size: 1.1rem; line-height: 1.8; margin-bottom: 15px; text-align: justify; }
        .options-grid { display: grid; gap: 8px; flex-grow: 1; }
        .btn { background: #21262d; border: 1px solid #30363d; color: var(--text); padding: 12px; border-radius: 8px; cursor: pointer; text-align: left; display: flex; gap: 8px; font-size: 1rem; }
        .btn.selected { background: #30363d; border-color: var(--accent); border-width: 2px; }
        .tf-row { display: flex; align-items: center; justify-content: space-between; background: #0d1117; padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #30363d; }
        .btn-tf { padding: 8px 15px; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; background: #21262d; color: white; font-weight: bold; }
        .btn-tf.active-t { background: var(--correct) !important; }
        .btn-tf.active-f { background: var(--wrong) !important; }
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .numpad-box { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--accent); text-align: center; }
        .ans-display { background: #000; color: var(--accent); font-size: 2rem; padding: 8px; border-radius: 8px; border: 2px solid var(--accent); margin-bottom: 10px; font-family: monospace; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .num-btn { background: #30363d; border: 1px solid #58a6ff22; color: white; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold; }
        .submit-btn { width: 100%; padding: 15px; background: var(--gold); color: #000; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        #final-area { display: none; width: 100%; max-width: 900px; padding: 20px; }
        .sol-card { background: var(--card); padding: 25px; border-radius: 12px; margin-top: 25px; border: 1px solid #30363d; text-align: left; }
        .ai-btn { background: linear-gradient(45deg, #4b0082, #8a2be2); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-top: 15px; display: flex; align-items: center; gap: 8px; }
        .ai-sol-box { display: none; background: #0d1117; padding: 20px; border-radius: 10px; border-left: 4px solid var(--ai); margin-top: 15px; line-height: 2; }
        .sol-item { display: block; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed #333; }
        .img-container { text-align: center; margin: 10px 0; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .img-container img { max-height: 200px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="timer-box">90:00</div>

<div id="nameModal">
    <div class="name-box">
        <h2>H·ªÜ TH·ªêNG KI·ªÇM TRA TO√ÅN H·ªåC</h2>
        <p style="color:var(--gold); font-weight:bold;">ThS. Tr·∫ßn Tr·ªçng Tr·ªã - GV Chuy√™n To√°n Tr∆∞·ªùng THPT Gia ƒê·ªãnh</p>
        <input type="text" id="studentName" class="name-input" placeholder="Nh·∫≠p H·ªç v√† T√™n h·ªçc sinh...">
        <button class="submit-btn" style="background:var(--accent); color:white;" onclick="startGame()">B·∫ÆT ƒê·∫¶U</button>
    </div>
</div>

<header>
    <h1 style="color:var(--gold); font-size: 1.5rem; margin: 5px 0;">CHINH PH·ª§C T√çCH PH√ÇN 12</h1>
    <p style="margin: 0; font-size: 0.9rem;">ThS. Tr·∫ßn Tr·ªçng Tr·ªã - GV Chuy√™n To√°n Tr∆∞·ªùng THPT Gia ƒê·ªãnh</p>
</header>

<div class="nav-section" id="nav-section">
    <div class="nav-label">Ph·∫ßn I</div><div class="nav-group" id="nav-p1"></div>
    <div class="nav-label">Ph·∫ßn II</div><div class="nav-group" id="nav-p2"></div>
    <div class="nav-label">Ph·∫ßn III</div><div class="nav-group" id="nav-p3"></div>
</div>

<div class="game-container" id="game-main">
    <div class="quiz-card mathjax-process">
        <div id="part-info" class="part-indicator"></div>
        <span id="q-title" style="color:var(--accent); font-weight:bold; margin-bottom:10px; display:block;"></span>
        <div id="q-area">
            <div id="q-text" class="q-text"></div>
            <div id="ans-zone" class="options-grid"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top: auto; padding-top: 20px;">
            <button class="btn" style="flex:1; justify-content:center; background:#444; color:white;" onclick="moveQ(-1)">TR∆Ø·ªöC</button>
            <button class="btn" style="flex:1; justify-content:center; background:var(--accent); color:white;" onclick="moveQ(1)">SAU</button>
        </div>
    </div>

    <div class="sidebar">
        <div id="numpad-container" class="numpad-box" style="display:none;">
            <div class="ans-display" id="disp">- - -</div>
            <div id="numpad-btns" class="numpad"></div>
        </div>
        <div class="image-box" style="position: relative; width: 100%; height: 200px; border: 1px solid #30363d; border-radius: 12px; overflow: hidden; background: #000;">
            <img src="hinh_game.jpg" style="width:100%; height:100%; object-fit:cover" onerror="this.src='https://via.placeholder.com/300x200?text=Mathematics'">
            <div id="grid" style="position: absolute; top:0; left:0; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(4, 1fr); z-index: 100;"></div>
        </div>
        <div style="background:var(--card); padding:15px; border-radius:12px; border:1px solid #30363d; text-align:center;">
            <div style="color:var(--gold); font-weight:bold; margin-bottom:10px; font-size: 0.9rem;">H·ªçc sinh: <span id="stu-name" style="color:white"></span></div>
            <button class="submit-btn" style="background:var(--wrong); color:white;" onclick="submitTest()">N·ªòP B√ÄI</button>
        </div>
    </div>
</div>

<div id="final-area" class="mathjax-process">
    <div style="text-align:center; padding:30px; background:var(--card); border-radius:15px; border:2px solid var(--gold);">
        <h2 style='color:var(--gold); margin:0;'>K·∫æT QU·∫¢ KI·ªÇM TRA</h2>
        <h3 id="final-score" style="color:var(--accent); font-size:2.5rem; margin:10px 0;"></h3>
        <div id="score-comment" style="font-weight:bold; font-size:1.2rem;"></div>
    </div>
    <div id="sol-content"></div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIs7hjIYOcbcIXjht4-kQurHkoQpm-ra1KSFxiiSiqMGpePvNAddwBWMboFAv02RfmZQ/exec";
    
    let timeLeft = 90 * 60;
    let timerInterval;
    let isFinished = false;

    const rawQuestions = [
        // PH·∫¶N I
        { part: 1, num: 1, type: 'v1', q: "M·ªánh ƒë·ªÅ n√†o d∆∞·ªõi ƒë√¢y l√† <b>sai</b>?", a: ["$\\displaystyle \\int f'(x) dx = f(x)+C$","$\\displaystyle \\int [f(x)+g(x)] dx = \\int f(x)dx + \\int g(x)dx$","$\\displaystyle \\int k f(x) dx = k \\int f(x)dx$","$\\displaystyle \\int [f(x)-g(x)] dx = \\int f(x)dx - \\int g(x)dx$"], c: 2, sol: "Kh·∫≥ng ƒë·ªãnh C sai v√¨ thi·∫øu ƒëi·ªÅu ki·ªán h·∫±ng s·ªë $k \\neq 0$. Theo l√Ω thuy·∫øt, t√≠nh ch·∫•t $\\displaystyle \\int k f(x) dx = k \\int f(x)dx$ ch·ªâ ƒë√∫ng khi h·∫±ng s·ªë $k$ kh√°c $0$." },
        { part: 1, num: 2, type: 'v1', q: "Nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\cos x$ l√†:", a: ["$-\\sin x + C$", "$\\sin x + C$", "$\\cos x + C$", "$-\\cos x + C$"], c: 1, sol: "Ta c√≥ $\\displaystyle (\\sin x)' = \\cos x$. Do ƒë√≥ $\\displaystyle \\int \\cos x dx = \\sin x + C$." },
        { part: 1, num: 3, type: 'v1', q: "T√¨m h·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = 5^x$.", a: ["$5^x + C$", "$5^x \\ln 5 + C$", "$\\displaystyle \\frac{5^x}{\\ln 5} + C$", "$\\displaystyle \\frac{5^{x+1}}{x+1} + C$"], c: 2, sol: "√Åp d·ª•ng c√¥ng th·ª©c nguy√™n h√†m h√†m s·ªë m≈©: $\\displaystyle \\int a^x dx = \\frac{a^x}{\\ln a} + C$." },
        { part: 1, num: 4, type: 'v1', q: "Cho h√†m s·ªë $f(x)$ x√°c ƒë·ªãnh tr√™n $K$ v√† $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)$ tr√™n $K$. Kh·∫≥ng ƒë·ªãnh n√†o ƒë√∫ng?", a: ["$f'(x) = F(x)$", "$F'(x) = f(x)$", "$F(x) = f(x)$", "$F'(x) = f'(x)$"], c: 1, sol: "Theo ƒë·ªãnh nghƒ©a: H√†m s·ªë $F(x)$ ƒë∆∞·ª£c g·ªçi l√† nguy√™n h√†m c·ªßa $f(x)$ n·∫øu $F'(x) = f(x)$." },
        { part: 1, num: 5, type: 'v1', q: "T√¨m $\\displaystyle \\int \\frac{1}{x^2} dx$.", a: ["$\\displaystyle \\frac{1}{x} + C$", "$\\displaystyle -\\frac{1}{x} + C$", "$\\displaystyle \\frac{1}{2x} + C$", "$\\ln x^2 + C$"], c: 1, sol: "Ta c√≥ $\\displaystyle \\int \\frac{1}{x^2} dx = \\int x^{-2} dx = \\frac{x^{-1}}{-1} + C = -\\frac{1}{x} + C$." },
        { part: 1, num: 6, type: 'v1', q: "H·ªç c√°c nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = x^2 - 3x + \\frac{1}{x}$ l√†:", a: ["$F(x) = 2x - 3 - \\frac{1}{x^2} + C$","$\\displaystyle F(x) = \\frac{x^3}{3} - \\frac{3}{2}x^2 + \\ln|x| + C$","$\\displaystyle F(x) = \\frac{x^3}{3} + \\frac{3}{2}x^2 + \\ln x + C$","$\\displaystyle F(x) = \\frac{x^3}{3} - \\frac{3}{2}x^2 + \\ln x + C$"], c: 1, sol: "L·∫•y nguy√™n h√†m t·ª´ng th√†nh ph·∫ßn: $\\displaystyle \\int x^2 dx = \\frac{x^3}{3}$, $\\displaystyle \\int -3x dx = -\\frac{3}{2}x^2$, $\\displaystyle \\int \\frac{1}{x} dx = \\ln|x|$." },
        { part: 1, num: 7, type: 'v1', q: "Cho h√†m s·ªë $y=f(x)$ li√™n t·ª•c tr√™n $K$ v√† $a, b, c \\in K$. M·ªánh ƒë·ªÅ n√†o sau ƒë√¢y <b>sai</b>?", a: ["$\\displaystyle \\int_a^b f(x)dx + \\int_c^b f(x)dx = \\int_a^c f(x)dx$","$\\displaystyle \\int_a^b f(x)dx = \\int_a^b f(t)dt$","$\\displaystyle \\int_a^b f(x)dx = -\\int_b^a f(x)dx$","$\\displaystyle \\int_a^a f(x)dx = 0$"], c: 0, sol: "Theo t√≠nh ch·∫•t c·ªông ƒëo·∫°n: $\\displaystyle \\int_a^c f(x)dx + \\int_c^b f(x)dx = \\int_a^b f(x)dx$. Ph∆∞∆°ng √°n A vi·∫øt sai th·ª© t·ª± c·∫≠n." },
        { part: 1, num: 8, type: 'v1', q: "Cho $F(x)$ l√† nguy√™n h√†m c·ªßa $f(x)$. Hi·ªáu $F(0)-F(1)$ b·∫±ng:", a: ["$\\displaystyle \\int_0^1 f(x)dx$", "$\\displaystyle \\int_0^1 F(x)dx$", "$\\displaystyle \\int_1^0 F(x)dx$", "$\\displaystyle \\int_1^0 f(x)dx$"], c: 3, sol: "Theo ƒë·ªãnh l√Ω Newton-Leibniz: $\\displaystyle \\int_a^b f(x)dx = F(b)-F(a)$. Thay $a=1, b=0$ ta ƒë∆∞·ª£c k·∫øt qu·∫£." },
        { part: 1, num: 9, type: 'v1', q: "Cho $f(1)=2, f(3)=9$. T√≠nh $I = \\displaystyle \\int_1^3 f'(x)dx$.", a: ["11", "7", "2", "18"], c: 1, sol: "$I = f(3) - f(1) = 9 - 2 = 7$." },
        { part: 1, num: 10, type: 'v1', q: "Di·ªán t√≠ch h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi $y=f(x)$, tr·ª•c ho√†nh v√† hai ƒë∆∞·ªùng th·∫≥ng $x=a, x=b$ ($a < b$) l√†:", a: ["$\\displaystyle S = \\pi \\int_a^b f^2(x)dx$","$\\displaystyle S = \\int_a^b f(x)dx$","$\\displaystyle S = \\pi \\int_a^b |f(x)|dx$","$\\displaystyle S = \\int_a^b |f(x)|dx$"], c: 3, sol: "ƒê√¢y l√† c√¥ng th·ª©c chu·∫©n t√≠nh di·ªán t√≠ch h√¨nh ph·∫≥ng trong SGK." },
        { part: 1, num: 11, type: 'v1', q: "Kh·∫≥ng ƒë·ªãnh n√†o ƒë√∫ng v·ªÅ di·ªán t√≠ch $S$? <div class='img-container'><img src='cau11.png'></div>", a: ["$S = \\displaystyle \\int_a^b [f_2(x)-f_1(x)] dx$", "$\\displaystyle S = \\int_a^b [f_1(x)-f_2(x)] dx$", "$S = \\displaystyle \\pi \\int_a^b [f_1(x)-f_2(x)]^2 dx$", "$S = \\displaystyle \\pi \\int_a^b [f_1(x)-f_2(x)] dx$"], c: 1, sol: "Quan s√°t h√¨nh v·∫Ω, tr√™n ƒëo·∫°n $[a,b]$, ƒë·ªì th·ªã $f_1(x)$ n·∫±m ph√≠a tr√™n $f_2(x)$ n√™n di·ªán t√≠ch b·∫±ng t√≠ch ph√¢n hi·ªáu h√†m tr√™n tr·ª´ h√†m d∆∞·ªõi." },
        { part: 1, num: 12, type: 'v1', q: "C√¥ng th·ª©c th·ªÉ t√≠ch $V$ c·ªßa v·∫≠t th·ªÉ gi·ªõi h·∫°n b·ªüi hai m·∫∑t ph·∫≥ng $x=a, x=b$ ($a < b$) c√≥ thi·∫øt di·ªán $S(x)$ l√†:", a: ["$V = \\displaystyle \\int_b^a S(x)dx$","$V = \\displaystyle \\pi \\int_a^b S(x)dx$","$V = \\displaystyle \\pi \\int_a^b S^2(x)dx$","$\\displaystyle V = \\int_a^b S(x)dx$"], c: 3, sol: "C√¥ng th·ª©c t√≠nh th·ªÉ t√≠ch v·∫≠t th·ªÉ t·ªïng qu√°t (kh√¥ng ph·∫£i kh·ªëi tr√≤n xoay)." },

        // PH·∫¶N II
        { part: 2, num: 1, type: 'v2', q: "Cho $F(x)$ l√† nguy√™n h√†m c·ªßa $f(x) = \\frac{x^2+1}{x}$ tr√™n $(0;+\\infty)$.", 
          items: [ {l: "$F(x) = f'(x)$", r: false}, {l: "$F(x)+2025$ l√† nguy√™n h√†m", r: true}, {l: "$F(x) = x^2 + \\ln x + 2025$", r: false}, {l: "$F(1) = 1.5 \\Rightarrow F(x) = \\frac{x^2}{2} + \\ln x + 1$", r: true} ], 
          sol: "<span class='sol-item'>a) <b>Sai:</b> Theo ƒë·ªãnh nghƒ©a $F'(x) = f(x)$.</span><span class='sol-item'>b) <b>ƒê√∫ng:</b> V√¨ $(F(x)+C)' = F'(x) = f(x)$.</span><span class='sol-item'>c) <b>Sai:</b> $\\displaystyle \\int (x + \\frac{1}{x})dx = \\frac{x^2}{2} + \\ln|x| + C$.</span><span class='sol-item'>d) <b>ƒê√∫ng:</b> Thay $x=1$ v√†o $x^2/2 + \\ln x + C = 1.5 \\Rightarrow C=1$." },
        { part: 2, num: 2, type: 'v2', q: "Cho h√†m s·ªë $f(x) = 6x^5 - x^e$. G·ªçi $I = \\int 6x^5 dx$ v√† $J = \\int x^e dx$.", 
          items: [ {l: "$A = \\int x^5 dx \\Rightarrow A = I/6$", r: true}, {l: "$\\int f(x) dx = I + J$", r: false}, {l: "$J = \\frac{x^{e+1}}{e+1} + C$", r: true}, {l: "$\\int_0^1 f(x)dx = 1 - \\frac{1}{e+1}$", r: true} ], 
          sol: "<span class='sol-item'>a) <b>ƒê√∫ng:</b> V√¨ $I = 6 \\int x^5 dx$.</span><span class='sol-item'>b) <b>Sai:</b> Ph·∫£i l√† d·∫•u tr·ª´: $I - J$.</span><span class='sol-item'>c) <b>ƒê√∫ng:</b> C√¥ng th·ª©c nguy√™n h√†m l≈©y th·ª´a.</span><span class='sol-item'>d) <b>ƒê√∫ng:</b> T√≠nh t√≠ch ph√¢n x√°c ƒë·ªãnh t·ª´ 0 ƒë·∫øn 1." },
        { part: 2, num: 3, type: 'v2', q: "Cho $f(x) = x + 5 - \\frac{6}{x}$.", 
          items: [ {l: "$f'(x) = 1 + 6/x^2$", r: true}, {l: "$\\int f(x)dx = 0.5x^2 + 5x - 6\\ln|x| + C$", r: true}, {l: "$F(2) = F(1) + \\int_1^2 f(x)dx$", r: true}, {l: "$G(-6) = -13 - 6\\ln 3$", r: true} ], 
          sol: "<span class='sol-item'>a) <b>ƒê√∫ng:</b> ƒê·∫°o h√†m c∆° b·∫£n.</span><span class='sol-item'>b) <b>ƒê√∫ng:</b> Nguy√™n h√†m t·ª´ng h·∫°ng t·ª≠.</span><span class='sol-item'>c) <b>ƒê√∫ng:</b> Theo Newton-Leibniz.</span><span class='sol-item'>d) <b>ƒê√∫ng:</b> Thay s·ªë ch√≠nh x√°c." },
        { part: 2, num: 4, type: 'v2', q: "Cho BBT c·ªßa ƒë·∫°o h√†m $f'(x)$ tr√™n $(0;+\\infty)$. <div class='img-container'><img src='cau4_ds.png'></div>", 
          items: [ {l: "$\\int_2^5 f'(x)dx = f(5)-f(2)$", r: true}, {l: "$f'(x) < 0$ tr√™n $(2,3)$", r: true}, {l: "$f(x)$ ƒë·ªìng bi·∫øn tr√™n $(3,5)$", r: true}, {l: "$f(2) > f(3)$", r: true} ], 
          sol: "<span class='sol-item'>a) <b>ƒê√∫ng:</b> Newton-Leibniz.</span><span class='sol-item'>b) <b>ƒê√∫ng:</b> Nh√¨n BBT ƒëo·∫°n [2,3] gi√° tr·ªã √¢m.</span><span class='sol-item'>c) <b>ƒê√∫ng:</b> Tr√™n (3,5) ƒë·∫°o h√†m d∆∞∆°ng.</span><span class='sol-item'>d) <b>ƒê√∫ng:</b> Do h√†m ngh·ªãch bi·∫øn tr√™n (2,3)." },

        // PH·∫¶N III
        { part: 3, num: 1, type: 'v3', q: "Bi·∫øt $\\displaystyle \\int (\\sin x - \\cos x)^2 dx = x + \\frac{1}{a} \\cos bx + C$. T√≠nh $a+b$.", c: "4", sol: "<span class='sol-step'>B∆∞·ªõc 1:</span> Khai tri·ªÉn $(\\sin x - \\cos x)^2 = 1 - 2\\sin x \\cos x = 1 - \\sin 2x$.<br><span class='sol-step'>B∆∞·ªõc 2:</span> Nguy√™n h√†m: $\\displaystyle \\int (1 - \\sin 2x) dx = x + \\frac{1}{2}\\cos 2x + C$.<br><span class='sol-step'>K·∫øt lu·∫≠n:</span> $a=2, b=2 \\Rightarrow a+b=4$." },
        { part: 3, num: 2, type: 'v3', q: "Cho $\\displaystyle \\int_2^7[2f(x)+3g(x)]=2$ v√† $\\displaystyle \\int_2^7[f(x)-2g(x)]=4$. T√≠nh $\\displaystyle \\int_2^7[f(x)-g(x)]$. (L√†m tr√≤n 2 ch·ªØ s·ªë TP).", c: "3.14", sol: "<span class='sol-step'>B∆∞·ªõc 1:</span> ƒê·∫∑t $A = \\int f, B = \\int g$. Gi·∫£i h·ªá $\\begin{cases} 2A+3B=2 \\\\ A-2B=4 \\end{cases} \\Rightarrow A=16/7, B=-6/7$.<br><span class='sol-step'>B∆∞·ªõc 2:</span> $A-B = 16/7 - (-6/7) = 22/7 \\approx 3.14$." },
        { part: 3, num: 3, type: 'v3', q: "Cho $F(x) = (ax^2+bx+c)e^x$ l√† nguy√™n h√†m c·ªßa $(x^2+1)e^x$. T√≠nh $a+b+c$.", c: "2", sol: "ƒê·∫°o h√†m $F'(x) = [ax^2+(2a+b)x+(b+c)]e^x$. ƒê·ªìng nh·∫•t v·ªõi $(x^2+1)e^x$ ƒë∆∞·ª£c $a=1, b=-2, c=3 \\Rightarrow a+b+c=2$." },
        { part: 3, num: 4, type: 'v3', q: "Cho h√†m s·ªë $\\displaystyle f(x) = \\begin{cases} 3x^2-x-9 & x \\ge 2 \\\\ x-1 & x < 2 \\end{cases}$. T√≠nh $\\displaystyle I = \\int_0^3 f(x)dx$.", c: "7.5", sol: "T√°ch c·∫≠n: $\\displaystyle I = \\int_0^2(x-1)dx + \\int_2^3(3x^2-x-9)dx = 0 + 7.5 = 7.5$." },
        { part: 3, num: 5, type: 'v3', q: "T√≠nh $f(3)$ bi·∫øt $S_A=4, S_B=10, f(0)=2$ d·ª±a tr√™n ƒë·ªì th·ªã $f'(x)$. <div class='img-container'><img src='cau5_kq.png'></div>", c: "-4", sol: "$f(3) = f(0) + S_A - S_B = 2 + 4 - 10 = -4$." },
        { part: 3, num: 6, type: 'v3', q: "M·ªôt khu√¥n vi√™n h√¨nh n·ª≠a ƒë∆∞·ªùng tr√≤n gi·ªõi h·∫°n b·ªüi $y=x^2$ v√† $y=\\sqrt{20-x^2}$. T√≠nh ti·ªÅn tr·ªìng hoa (gi√° 250k/$m^2$). <div class='img-container'><img src='cau6_kq.png'></div>", c: "4985", sol: "<b>Gi·∫£i chi ti·∫øt:</b><div class='img-container'><img src='cau6_kq_lg.png'></div><br>1. Giao ƒëi·ªÉm $x = \\pm 2$.<br>2. Di·ªán t√≠ch $\\displaystyle S \\approx 19.9396 m^2$.<br>3. T·ªïng ti·ªÅn: $19.9396 \\times 250 \\approx 4985$ ngh√¨n ƒë·ªìng." }
    ];

    let currentQuestions = [];
    let userAnswers = [];
    let currentIdx = 0;
    let studentName = "";

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function startGame() {
        const input = document.getElementById('studentName').value;
        if(!input.trim()) return alert("H·ªçc sinh h√£y nh·∫≠p h·ªç t√™n nh√©!");
        studentName = input;
        
        const p1 = shuffle(rawQuestions.filter(q => q.part === 1));
        const p2 = shuffle(rawQuestions.filter(q => q.part === 2));
        const p3 = shuffle(rawQuestions.filter(q => q.part === 3));

        p1.forEach(q => {
            let options = q.a.map((text, idx) => ({ text, isCorrect: idx === q.c }));
            shuffle(options);
            q.a = options.map(o => o.text);
            q.c = options.findIndex(o => o.isCorrect);
        });

        currentQuestions = [...p1, ...p2, ...p3];
        userAnswers = new Array(currentQuestions.length).fill(null);

        document.getElementById('nameModal').style.display = 'none';
        document.getElementById('nav-section').style.display = 'flex';
        document.getElementById('game-main').style.display = 'grid';
        document.getElementById('stu-name').innerText = studentName;
        
        initNav(); initNumpad(); render(); startTimer();
    }

    function startTimer() {
        document.getElementById('timer-box').style.display = 'block';
        timerInterval = setInterval(() => {
            if(isFinished) return clearInterval(timerInterval);
            timeLeft--;
            let mins = Math.floor(timeLeft / 60);
            let secs = timeLeft % 60;
            document.getElementById('timer-box').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            if(timeLeft <= 300) document.getElementById('timer-box').classList.add('timer-warning');
            if(timeLeft <= 0) { finish(); }
        }, 1000);
    }

    function initNav() {
        const groups = [document.getElementById('nav-p1'), document.getElementById('nav-p2'), document.getElementById('nav-p3')];
        groups.forEach(g => g.innerHTML = '');
        currentQuestions.forEach((q, i) => {
            let b = document.createElement('button');
            b.className = 'nav-btn'; b.id = 'nav-' + i; b.innerText = i + 1;
            b.onclick = () => { currentIdx = i; render(); };
            groups[q.part-1].appendChild(b);
        });
    }

    function initNumpad() {
        const zone = document.getElementById('numpad-btns');
        const keys = [1,2,3,4,5,6,7,8,9,0,'.','-'];
        zone.innerHTML = keys.map(k => `<button class="num-btn" onclick="pressKey('${k}')">${k}</button>`).join('') + 
                         `<button class="num-btn" style="grid-column:span 3; background:var(--wrong)" onclick="pressKey('C')">X√ìA</button>`;
    }

    function render() {
        const q = currentQuestions[currentIdx];
        document.getElementById('part-info').innerText = q.part === 1 ? "PH·∫¶N I: TR·∫ÆC NGHI·ªÜM 4 PH∆Ø∆†NG √ÅN" : (q.part === 2 ? "PH·∫¶N II: TR·∫ÆC NGHI·ªÜM ƒê√öNG SAI" : "PH·∫¶N III: TR·∫ÆC NGHI·ªÜM TR·∫¢ L·ªúI NG·∫ÆN");
        document.getElementById('q-title').innerText = "C√¢u " + (currentIdx + 1) + ".";
        document.getElementById('q-text').innerHTML = q.q;
        const zone = document.getElementById('ans-zone'); zone.innerHTML = '';
        const numpad = document.getElementById('numpad-container'); numpad.style.display = 'none';

        if(q.type === 'v1') {
            q.a.forEach((opt, i) => {
                let b = document.createElement('button'); b.className = 'btn';
                if(userAnswers[currentIdx] === i) b.classList.add('selected');
                b.innerHTML = `<b>${['A','B','C','D'][i]}.</b> ${opt}`;
                b.onclick = () => { userAnswers[currentIdx] = i; render(); updateNav(); };
                zone.appendChild(b);
            });
        } else if(q.type === 'v2') {
            let curV2 = userAnswers[currentIdx] || [null, null, null, null];
            q.items.forEach((item, i) => {
                let d = document.createElement('div'); d.className = 'tf-row';
                d.innerHTML = `<div><b>${['a','b','c','d'][i]})</b> ${item.l}</div>
                    <div>
                        <button class='btn-tf ${curV2[i] === true ? 'active-t' : ''}' onclick='setTF(${i},true)'>ƒê√∫ng</button>
                        <button class='btn-tf ${curV2[i] === false ? 'active-f' : ''}' onclick='setTF(${i},false)'>Sai</button>
                    </div>`;
                zone.appendChild(d);
            });
        } else {
            numpad.style.display = 'block';
            document.getElementById('disp').innerText = userAnswers[currentIdx] || "- - -";
        }
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + currentIdx).classList.add('active');
        MathJax.typesetPromise();
    }

    function setTF(idx, val) {
        if(!userAnswers[currentIdx]) userAnswers[currentIdx] = [null, null, null, null];
        userAnswers[currentIdx][idx] = val; render(); updateNav();
    }

    function pressKey(k) {
        let cur = userAnswers[currentIdx] || "";
        if(k === 'C') cur = ""; else if(cur.length < 10) cur += k;
        userAnswers[currentIdx] = cur;
        document.getElementById('disp').innerText = cur || "- - -";
        updateNav();
    }

    function moveQ(step) { let next = currentIdx + step; if(next >= 0 && next < currentQuestions.length) { currentIdx = next; render(); } }

    function updateNav() {
        currentQuestions.forEach((q, i) => {
            let b = document.getElementById('nav-' + i); b.classList.remove('done');
            let ans = userAnswers[i];
            if(q.type === 'v2') { if(ans && !ans.includes(null)) b.classList.add('done'); }
            else { if(ans !== null && ans !== "") b.classList.add('done'); }
        });
    }

    function submitTest() {
        if(confirm("X√°c nh·∫≠n n·ªôp b√†i?")) finish();
    }

    function finish() {
        if(isFinished) return;
        isFinished = true;
        clearInterval(timerInterval);
        document.getElementById('timer-box').style.display = 'none';

        let sc = 0;
        currentQuestions.forEach((q, i) => {
            if(q.type === 'v1' && userAnswers[i] == q.c) sc += 0.25;
            else if(q.type === 'v2' && userAnswers[i]) {
                let c = 0; q.items.forEach((it, j) => { if(userAnswers[i][j] === it.r) c++; });
                sc += [0, 0.1, 0.25, 0.5, 1.0][c];
            } else if(q.type === 'v3' && userAnswers[i] == q.c) sc += 0.5;
        });

        const score = parseFloat(sc.toFixed(2));
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name: studentName, score: score }) });

        document.getElementById('game-main').style.display = 'none';
        document.getElementById('nav-section').style.display = 'none';
        document.getElementById('final-area').style.display = 'block';
        document.getElementById('final-score').innerText = "ƒêi·ªÉm: " + score;

        const cm = document.getElementById('score-comment');
        if(sc < 3.5) { cm.innerText = "B·∫°n c·∫ßn c·ªë g·∫Øng r·∫•t nhi·ªÅu."; cm.style.color = "#da3633"; }
        else if(sc < 5) { cm.innerText = "B·∫°n c·∫ßn c·ªë g·∫Øng."; cm.style.color = "#e67e22"; }
        else if(sc < 6.5) { cm.innerText = "ƒêi·ªÉm ch·∫•p nh·∫≠n ƒë∆∞·ª£c."; cm.style.color = "#f1c40f"; }
        else if(sc < 8) { cm.innerText = "B·∫°n kh√°."; cm.style.color = "#3498db"; }
        else if(sc < 9) { cm.innerText = "B·∫°n gi·ªèi."; cm.style.color = "#2ecc71"; }
        else if(sc < 9.8) { cm.innerText = "Xu·∫•t s·∫Øc."; cm.style.color = "var(--accent)"; }
        else { cm.innerText = "ƒê·ªânh c·ªßa ch√≥p! üèÜ"; cm.style.color = "var(--gold)"; }

        let html = "";
        currentQuestions.forEach((q, i) => {
            let optH = "";
            if(q.type === 'v1') q.a.forEach((opt, idx) => optH += `<div style='margin-left:20px; color:${q.c==idx?'#2ecc71':''}'><b>${['A','B','C','D'][idx]}.</b> ${opt} ${q.c==idx?'(ƒê√∫ng)':''}</div>`);
            else if(q.type === 'v2') q.items.forEach((it, idx) => optH += `<div style='margin-left:20px;'><b>${['a','b','c','d'][idx]})</b> ${it.l} <span style='color:var(--gold)'>[${it.r?'ƒê√∫ng':'Sai'}]</span></div>`);
            
            html += `<div class='sol-card'>
                <b style='color:var(--gold)'>C√¢u ${i+1}:</b><br>${q.q}
                <div style='margin:10px 0;'>${optH}</div>
                <button class='ai-btn' onclick='toggleAI(${i})'>ü§ñ GI·∫¢I CHI TI·∫æT</button>
                <div class='ai-sol-box' id='box-${i}'>${q.sol}</div>
            </div>`;
        });
        document.getElementById('sol-content').innerHTML = html;
        MathJax.typesetPromise();
    }
    function toggleAI(idx) { let b = document.getElementById('box-'+idx); b.style.display = b.style.display === 'block' ? 'none' : 'block'; }
</script>
</body>
</html>
